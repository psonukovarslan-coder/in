<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TG Coin</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { --bg: #0a1a2e; --card: #112240; --accent: #00d4ff; --text: #e0f2ff; --success: #00ff88; --warning: #ffaa00; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
        header { padding: 16px; text-align: center; font-weight: 700; font-size: 20px; background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); }
        main { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 20px; padding-bottom: 140px; overflow-y: auto; }
        #coin { width: 160px; height: 160px; cursor: pointer; margin: 20px; filter: drop-shadow(0 0 20px rgba(0,212,255,0.5)); }
        #coin:active { transform: scale(0.88); }
        .stats { background: var(--card); padding: 16px; border-radius: 16px; width: 90%; max-width: 320px; margin: 16px 0; }
        .stat { display: flex; justify-content: space-between; margin: 8px 0; font-size: 14px; }
        .value { color: var(--success); font-weight: bold; }
        .menu { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); padding: 16px; border-radius: 16px 16px 0 0; z-index: 1000; }
        .tabs { display: flex; justify-content: space-around; margin-bottom: 12px; }
        .tab-btn { background: transparent; color: #88aabb; border: none; padding: 8px; border-radius: 12px; font-size: 13px; flex: 1; }
        .tab-btn.active { background: var(--accent); color: #000; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        button { background: var(--accent); color: #000; border: none; padding: 10px; border-radius: 12px; margin: 6px 0; font-weight: bold; }
        .upgrade { background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.2); border-radius: 12px; padding: 12px; margin: 8px 0; display: flex; justify-content: space-between; align-items: center; }
        .ach { padding: 12px; border-radius: 10px; margin: 6px 0; background: rgba(0,255,0,0.1); border: 1px solid rgba(0,255,0,0.3); text-align: center; }
        .ach.done { opacity: 0.6; }
        .list-item { background: rgba(255,255,255,0.05); margin: 6px 0; padding: 10px; border-radius: 10px; font-size: 14px; }
        .your-place { font-style: italic; color: #aaa; margin-top: 10px; text-align: center; }
        .update-time { font-size: 12px; color: #666; text-align: center; margin-top: 8px; }
    </style>
</head>
<body>
    <header>TG Coin — <span id="nickname">...</span></header>

    <main>
        <img id="coin" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSI5MCIgZmlsbD0iIzAwZDRmZiIgc3Ryb2tlPSIjMDBhYWZmIiBzdHJva2Utd2lkdGg9IjYiLz48dGV4dCB4PSIxMDAiIHk9IjEwNSIgZm9udC1zaXplPSI0NSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzAwMCIgZm9udC13ZWlnaHQ9ImJvbGQiPlRHPC90ZXh0Pjx0ZXh0IHg9IjEwMCIgeT0iMTM1IiBmb250LXNpemU9IjIyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjMDAwIj5Db2luPC90ZXh0Pjwvc3ZnPg==" onclick="tap()">
        <div class="stats">
            <div class="stat">TG Coin: <span class="value" id="coins">0</span></div>
            <div class="stat">Авто/сек: <span class="value" id="auto">0</span></div>
            <div class="stat">Энергия: <span id="energy">100</span>/<span id="max">100</span></div>
            <div class="stat">Рефералы: <span id="refs">0</span></div>
        </div>
    </main>

    <div class="menu">
        <div class="tabs">
            <button class="tab-btn active" data-tab="up">УЛУЧШЕНИЯ</button>
            <button class="tab-btn" data-tab="top">ТОП-100</button>
            <button class="tab-btn" data-tab="ach">ДОСТИЖЕНИЯ</button>
        </div>

        <div id="up" class="tab-content active">
            <div class="upgrade">
                <div><strong>Авто-кликер</strong><br><small>+1 TG/сек</small></div>
                <button id="autoBtn">100 TG</button>
            </div>
            <div class="upgrade">
                <div><strong>Пригласить друга</strong><br><small>+200 TG +10% авто</small></div>
                <button onclick="invite()">Пригласить</button>
            </div>
        </div>

        <div id="top" class="tab-content">
            <div class="list" id="topList">Загрузка топа...</div>
            <div id="yourPlace" class="your-place"></div>
            <div id="updateTime" class="update-time">Обновляется каждые 30 сек</div>
        </div>

        <div id="ach" class="tab-content">
            <div class="ach" id="ach4">
                Подписка на @dubna_book — +100 энергии<br>
                <button onclick="checkSub()">Получить бонус</button>
            </div>
        </div>

        <button id="ad-btn" onclick="ad()">Реклама (+500)</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();
        const userId = tg.initDataUnsafe?.user?.id || 'guest';
        const nickname = tg.initDataUnsafe?.user?.username || tg.initDataUnsafe?.user?.first_name || 'Player';
        document.getElementById('nickname').textContent = nickname;

        const DB = { get: k => JSON.parse(localStorage.getItem(`tgcoin_${userId}_${k}`) || 'null'), set: (k,v) => localStorage.setItem(`tgcoin_${userId}_${k}`, JSON.stringify(v)) };
        let game = DB.get('game') || {c:0,a:0,e:100,m:100,b:1,r:0,l:0,t:0};
        const upgrades = DB.get('upgrades') || {a:0};
        let subDone = DB.get('sub') || false;

        function save() {
            DB.set('game', game);
            DB.set('upgrades', upgrades);
            DB.set('sub', subDone);
            tg.sendData(`save_${Math.floor(game.c)}_${game.a}_${Math.floor(game.e)}_${game.m}_${game.r}_${game.t}`);
        }

        function tap() {
            if(game.e>0){
                game.c+=game.b; game.e--;
                update();
            }
        }

        function buyAuto() {
            const cost = 100*Math.pow(1.8,upgrades.a);
            if(game.c>=cost){ game.c-=cost; upgrades.a++; game.a=upgrades.a; update(); }
        }

        function invite() { tg.sendData('invite'); tg.showAlert('Реферальная ссылка отправлена в чат!'); }

        function ad() { if(Date.now()-game.l>120000){game.c+=500;game.l=Date.now();update();} }

        function checkSub() {
            if (subDone) {
                tg.showAlert('Вы уже получили бонус за подписку!');
                return;
            }
            tg.openLink('https://t.me/dubna_book');
            tg.showPopup({
                title: "Подпишись на канал",
                message: "После подписки нажми 'Я подписался'",
                buttons: [{ type: "ok", text: "Я подписался" }]
            }, () => {
                subDone = true;
                game.e = Math.min(game.m, game.e + 100);
                update();
                updateSubAchievement();
                tg.showAlert('+100 энергии начислено!');
            });
        }

        function update() {
            document.getElementById('coins').textContent = Math.floor(game.c).toLocaleString();
            document.getElementById('auto').textContent = game.a.toFixed(1);
            document.getElementById('energy').textContent = Math.floor(game.e);
            document.getElementById('max').textContent = game.m;
            document.getElementById('refs').textContent = game.r;
            document.getElementById('autoBtn').textContent = Math.floor(100*Math.pow(1.8,upgrades.a)) + ' TG';
            save();
        }

        function updateSubAchievement() {
            const ach = document.getElementById('ach4');
            if (subDone) {
                ach.innerHTML = 'Подписка на @dubna_book — +100 энергии<br><span style="color:#0f0">Выполнено</span>';
                ach.classList.add('done');
            } else {
                ach.innerHTML = 'Подписка на @dubna_book — +100 энергии<br><button onclick="checkSub()">Получить бонус</button>';
                ach.classList.remove('done');
            }
        }

        // === АВТООБНОВЛЕНИЕ ТОП-100 КАЖДЫЕ 30 СЕКУНД ===
        async function updateTop() {
            const topList = document.getElementById('topList');
            const yourPlace = document.getElementById('yourPlace');
            const updateTime = document.getElementById('updateTime');
            topList.innerHTML = 'Загрузка топа...';

            try {
                const res = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://raw.githubusercontent.com/psonukovarslan-coder/in/main/top100.json'));
                const data = await res.json();
                const top100 = JSON.parse(data.contents);

                let html = '';
                top100.forEach((p, i) => {
                    html += `<div class="list-item"><strong>${i+1}. ${p.nick}</strong> — ${p.coins.toLocaleString()} TG</div>`;
                });
                topList.innerHTML = html;

                const player = top100.find(p => p.id == userId);
                if (player) {
                    yourPlace.textContent = `Ты в топе: #${top100.indexOf(player) + 1}`;
                } else {
                    yourPlace.textContent = `Ты не в топ-100. Твои: ${Math.floor(game.c).toLocaleString()} TG`;
                }

                const now = new Date().toLocaleTimeString();
                updateTime.textContent = `Обновлено: ${now}`;
            } catch (e) {
                topList.innerHTML = '<div class="list-item">Ошибка загрузки топа</div>';
                updateTime.textContent = 'Ошибка сети';
            }
        }

        // Запуск автообновления
        setInterval(updateTop, 30000); // каждые 30 сек

        // === ТАБЫ ===
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.addEventListener('click', () => {
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                document.getElementById(b.dataset.tab).classList.add('active');
                document.querySelectorAll('.tab-btn').forEach(bb => bb.classList.remove('active'));
                b.classList.add('active');
                if (b.dataset.tab === 'top') updateTop();
                if (b.dataset.tab === 'ach') updateSubAchievement();
            });
        });

        // Инициализация
        setInterval(() => {
            game.c += game.a * 0.1;
            game.e = Math.min(game.m, game.e + 0.5);
            update();
        }, 1000);

        window.addEventListener('beforeunload', save);

        update();
        updateSubAchievement();
        updateTop(); // первый запуск
    </script>
</body>
</html>
